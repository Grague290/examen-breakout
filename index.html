<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Breakout Game</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.js"></script>
  </head>

  <body style="margin:0; padding:0; overflow:hidden;">
    <script>
      let paddle, ball;
      let blocks = [];
      let level = 1;
      let lives = 5;
      let score = 0;
      let gameStarted = false;
      let flashBlocks = [];
      let gameOver = false;
      let gameOverSize = 32;
      let gameOverAlpha = 255;
      let pauseButton, resetButton;
      let isPaused = false;
      let canvas;
      const canvasWidth = 600;
      const canvasHeight = 400;


      function setup() {
        canvas = createCanvas(canvasWidth, canvasHeight);
        centerCanvas();
      
        paddle = new Paddle();
        ball = new Ball();
        setupLevel(level);
      
        pauseButton = createButton("⏸ Pausar");
        pauseButton.mousePressed(togglePause);
      
        resetButton = createButton("🔄 Reiniciar");
        resetButton.mousePressed(resetGame);
      
        positionButtons();
      }
      

      function draw() {
        background(0);
        drawInfo();

        paddle.show();
        paddle.update();

        if (gameStarted) ball.update();
        ball.show();

        for (let i = blocks.length - 1; i >= 0; i--) {
          blocks[i].show();
          if (ball.hits(blocks[i])) {
            if (blocks[i].hitsLeft > 1) {
              blocks[i].hitsLeft--;
            } else if (!blocks[i].indestructible) {
              blocks.splice(i, 1);
              score++;
            }

            ball.reverse();

            flashBlocks.push(blocks[i]);
            setTimeout(() => {
              flashBlocks = flashBlocks.filter(b => b !== blocks[i]);
            }, 100);
          }
        }

        if (ball.offScreen()) {
          lives--;
          gameStarted = false;
          ball.reset();

          if (lives <= 0) {
            gameOver = true;
            noLoop();
          }
        }

        if (blocks.length === 0) {
          level++;
          if (level > 3) {
            noLoop();
            textSize(32);
            fill(0, 255, 0);
            textAlign(CENTER, CENTER);
            text("¡Ganaste!", width / 2, height / 2);
            return;
          }
          setupLevel(level);
          ball.reset();
          gameStarted = false;
        }

        if (gameOver) {
          textAlign(CENTER, CENTER);
          textSize(gameOverSize);
          fill(255, gameOverAlpha);
          text("GAME OVER", width / 2, height / 2);
          gameOverSize += 0.5;
          gameOverAlpha -= 2;
          if (gameOverAlpha <= 0) {
            gameOverAlpha = 255;
            gameOverSize = 32;
          }
        }
      }

      function centerCanvas() {
        let x = (windowWidth - canvasWidth) / 2;
        let y = (windowHeight - canvasHeight) / 2;
        canvas.position(x, y);
      }
      
      function positionButtons() {
        let x = canvas.position().x + canvasWidth + 20;
        let y = canvas.position().y;
      
        pauseButton.position(x, y + 40);
        resetButton.position(x, y + 80);
      }

      function windowResized() {
        centerCanvas();
        positionButtons();
      }
      

      function drawInfo() {
        fill(255);
        textSize(16);
        text(`Nivel: ${level}  Puntos: ${score}  Vidas: ${lives}`, 10, 20);
      }

      function togglePause() {
        if (isPaused) {
          loop();
          pauseButton.html("⏸ Pausar");
        } else {
          noLoop();
          pauseButton.html("▶ Reanudar");
        }
        isPaused = !isPaused;
      }

      function resetGame() {
        level = 1;
        lives = 3;
        score = 0;
        gameOver = false;
        gameOverSize = 32;
        gameOverAlpha = 255;
        isPaused = false;
        pauseButton.html("⏸ Pausar");
        setupLevel(level);
        ball.reset();
        loop();
      }

      function setupLevel(n) {
        blocks = [];
        let rows = 3 + n;
        let cols = 10;
        let blockWidth = width / cols;
        let blockHeight = 20;
      
        let totalBlocks = rows * cols;
      
        // Generar índices aleatorios únicos
        let specialIndexes = [];
        let required = (n === 2) ? 1 : (n === 3) ? 3 : 0;
        while (specialIndexes.length < required + (n === 3 ? 1 : 0)) {
          let randIndex = floor(random(totalBlocks));
          if (!specialIndexes.includes(randIndex)) {
            specialIndexes.push(randIndex);
          }
        }
      
        let tripleHitIndexes = specialIndexes.slice(0, required);
        let indestructibleIndex = (n === 3) ? specialIndexes[specialIndexes.length - 1] : -1;
      
        let index = 0;
      
        for (let r = 0; r < rows; r++) {
          for (let c = 0; c < cols; c++) {
            let x = c * blockWidth;
            let y = 40 + r * blockHeight;
      
            let hits = 1;
            let indestructible = false;
      
            if (tripleHitIndexes.includes(index)) hits = 3;
            if (index === indestructibleIndex) indestructible = true;
      
            blocks.push(new Block(x, y, blockWidth, blockHeight, hits, indestructible));
            index++;
          }
        }
      
        ball.setSpeed(n);
      }
      

      function keyPressed() {
        if (keyCode === LEFT_ARROW || key === 'a' || key === 'A') {
          paddle.move(-1);
        } else if (keyCode === RIGHT_ARROW || key === 'd' || key === 'D') {
          paddle.move(1);
        }

        if (key === ' ' && !gameStarted && !gameOver) {
          gameStarted = true;
        }
      }

      function keyReleased() {
        if (
          keyCode === LEFT_ARROW || keyCode === RIGHT_ARROW ||
          key === 'a' || key === 'A' || key === 'd' || key === 'D'
        ) {
          paddle.move(0);
        }
      }

      class Paddle {
        constructor() {
          this.w = 100;
          this.h = 15;
          this.x = width / 2 - this.w / 2;
          this.speed = 7;
          this.dir = 0;
        }

        move(dir) {
          this.dir = dir;
        }

        update() {
          this.x += this.dir * this.speed;
          this.x = constrain(this.x, 0, width - this.w);
        }

        show() {
          fill(255);
          rect(this.x, height - this.h - 10, this.w, this.h);
        }
      }

      class Ball {
        constructor() {
          this.r = 10;
          this.reset();
        }

        reset() {
          this.x = width / 2;
          this.y = height - 30;
          this.speed = 4;
          this.setSpeed(level);
          this.vx = random([-this.speed, this.speed]);
          this.vy = -this.speed;
        }

        setSpeed(level) {
          this.speed = 4 + level;
        }

        update() {
          this.x += this.vx;
          this.y += this.vy;

          if (this.x < 0 || this.x > width) this.vx *= -1;
          if (this.y < 0) this.vy *= -1;

          if (
            this.y + this.r > height - 25 &&
            this.x > paddle.x &&
            this.x < paddle.x + paddle.w
          ) {
            this.vy *= -1;
          }
        }

        reverse() {
          this.vy *= -1;
        }

        offScreen() {
          return this.y > height;
        }

        show() {
          fill(255);
          ellipse(this.x, this.y, this.r * 2);
        }

        hits(block) {
          return (
            this.x + this.r > block.x &&
            this.x - this.r < block.x + block.w &&
            this.y + this.r > block.y &&
            this.y - this.r < block.y + block.h
          );
        }
      }

      class Block {
        constructor(x, y, w, h, hitsLeft, indestructible = false) {
          this.x = x;
          this.y = y;
          this.w = w;
          this.h = h;
          this.hitsLeft = hitsLeft;
          this.indestructible = indestructible;

          if (!this.indestructible && this.hitsLeft === 1) {
            this.color = color(random(100, 255), random(100, 255), random(100, 255));
          }
        }

        show() {
          push();
          if (this.indestructible) {
            fill(0);
            stroke(255);
            strokeWeight(2);
          } else {
            stroke(0);
            strokeWeight(1);
            if (flashBlocks.includes(this)) {
              fill(255, 255, 0);
            } else if (this.hitsLeft >= 2) {
              fill(255);
            } else {
              fill(this.color);
            }
          }
          rect(this.x, this.y, this.w, this.h);
          pop();
        }
      }
    </script>
  </body>
</html>
